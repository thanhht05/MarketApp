<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Gi·ªè h√†ng - Mobile UI</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f4f6f8;
        padding-bottom: 280px; /* TƒÉng padding ƒë√°y ƒë·ªÉ kh√¥ng b·ªã che */
        font-family: "Segoe UI", sans-serif;
      }

      /* HEADER */
      .page-title {
        font-weight: 800;
        font-size: 1.1rem;
        color: #2d3436;
      }

      /* PRODUCT CARD */
      .product-card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        border: 1px solid #f1f2f6;
      }

      .product-name {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 4px;
        color: #2d3436;
      }

      .product-price {
        color: #636e72;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* Style cho t·ªïng ti·ªÅn item */
      .item-total-display {
        color: #00b894;
        font-weight: 800;
        font-size: 1.1rem;
        margin-top: 2px;
      }

      /* QUANTITY */
      .qty-box {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 4px;
        border: 1px solid #dfe6e9;
      }

      .qty-btn {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        border: none;
        background: white;
        font-weight: 800;
        color: #2d3436;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: all 0.2s;
        cursor: pointer;
      }

      .qty-btn:active {
        transform: scale(0.9);
      }

      .qty-number {
        width: 30px;
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
      }

      /* CHECKOUT FIXED */
      .fixed-checkout {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-radius: 24px 24px 0 0;
        padding: 20px;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.08);
        z-index: 1000;
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .total-label {
        font-size: 1rem;
        font-weight: 700;
        color: #636e72;
      }

      .total-price {
        font-size: 1.5rem;
        font-weight: 900;
        color: #0984e3;
      }

      .cash-box {
        background: #f1f2f6;
        border-radius: 14px;
        padding: 12px 16px;
        margin-bottom: 16px;
      }

      .cash-input {
        border: none;
        background: transparent;
        width: 140px;
        text-align: right;
        font-size: 1.2rem;
        font-weight: 800;
        outline: none;
        color: #2d3436;
      }

      .btn-pay {
        background: #00b894;
        color: white;
        border: none;
        width: 100%;
        padding: 16px;
        border-radius: 16px;
        font-weight: 800;
        font-size: 1.1rem;
        box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
      }

      .btn-pay:active {
        transform: scale(0.98);
      }

      .change-result {
        text-align: center;
        margin-top: 12px;
        min-height: 28px;
        font-weight: 800;
        font-size: 1.1rem;
      }
    </style>
  </head>

  <body>
    <div class="container py-3">
      <div class="page-title mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</div>

      <div
        class="product-card"
        th:each="p : ${cartItems}"
        th:data-price="${p.price}"
      >
        <div>
          <div class="product-name" th:text="${p.name}">T√™n SP</div>

          <div class="product-price">
            ƒê∆°n gi√°:
            <span
              th:text="${#numbers.formatDecimal(p.price,0,'COMMA',0,'POINT')}"
              >0</span
            >
            ‚Ç´
          </div>

          <div class="item-total-display">
            <span
              class="item-sum"
              th:text="${#numbers.formatDecimal(p.price * p.quantity,0,'COMMA',0,'POINT')}"
              >0</span
            >
            ‚Ç´
          </div>
        </div>

        <div class="qty-box">
          <button class="qty-btn btn-minus">‚àí</button>
          <div class="qty-number" th:text="${p.quantity}">1</div>
          <button class="qty-btn text-success btn-plus">+</button>
        </div>
      </div>
    </div>

    <div class="fixed-checkout">
      <div class="total-row">
        <span class="total-label">T·ªïng thanh to√°n</span>
        <span class="total-price">
          <span
            id="totalValue"
            th:text="${#numbers.formatDecimal(totalPrice,0,'COMMA',0,'POINT')}"
            >0</span
          >
          ‚Ç´
        </span>
      </div>

      <div class="cash-box d-flex justify-content-between align-items-center">
        <span class="small fw-bold text-muted">KH√ÅCH ƒê∆ØA</span>
        <input
          type="number"
          id="inputGuestMoney"
          class="cash-input"
          placeholder="0"
          inputmode="numeric"
        />
      </div>

      <button class="btn-pay" onclick="handlePayment()">THANH TO√ÅN NGAY</button>
      <button style="margin-top: 20px; background-color: red" class="btn-pay">
        <a
          style="
            color: #fff;
            text-decoration: none;
            display: inline-block;
            width: 100%;
            padding: 10px 0;
          "
          href="/deleteCart"
          >XO√Å T·∫§T C·∫¢</a
        >
      </button>

      <div class="change-result" id="changeOutput"></div>
    </div>

    <script>
      // H√†m format s·ªë ti·ªÅn sang d·∫°ng xxx.xxx (v√≠ d·ª•: 10.000)
      function formatMoney(amount) {
        return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }

      // H√†m t√≠nh l·∫°i to√†n b·ªô gi·ªè h√†ng
      function updateCartTotals() {
        let grandTotal = 0;

        // Duy·ªát qua t·ª´ng th·∫ª s·∫£n ph·∫©m
        document.querySelectorAll(".product-card").forEach((card) => {
          const price = parseInt(card.getAttribute("data-price")); // L·∫•y gi√° g·ªëc
          const qty = parseInt(card.querySelector(".qty-number").innerText); // L·∫•y s·ªë l∆∞·ª£ng
          const itemTotal = price * qty;

          // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªïng ti·ªÅn c·ªßa item ƒë√≥
          card.querySelector(".item-sum").innerText = formatMoney(itemTotal);

          // C·ªông d·ªìn v√†o t·ªïng ti·ªÅn c·∫£ gi·ªè
          grandTotal += itemTotal;
        });

        // C·∫≠p nh·∫≠t s·ªë t·ªïng ·ªü d∆∞·ªõi footer
        document.getElementById("totalValue").innerText =
          formatMoney(grandTotal);

        // Reset l·∫°i k·∫øt qu·∫£ t√≠nh ti·ªÅn th·ª´a n·∫øu c√≥
        document.getElementById("changeOutput").innerText = "";
      }

      // X·ª≠ l√Ω n√∫t TƒÉng
      document.querySelectorAll(".btn-plus").forEach((btn) => {
        btn.addEventListener("click", function () {
          const qtyEl = this.previousElementSibling;
          let qty = parseInt(qtyEl.innerText);
          qtyEl.innerText = qty + 1;

          updateCartTotals(); // G·ªçi h√†m t√≠nh to√°n
        });
      });

      // X·ª≠ l√Ω n√∫t Gi·∫£m
      document.querySelectorAll(".btn-minus").forEach((btn) => {
        btn.addEventListener("click", function () {
          const qtyEl = this.nextElementSibling;
          let qty = parseInt(qtyEl.innerText);

          if (qty > 1) {
            qtyEl.innerText = qty - 1;
            updateCartTotals(); // G·ªçi h√†m t√≠nh to√°n
          }
        });
      });

      // X·ª≠ l√Ω Thanh to√°n
      function handlePayment() {
        // L·∫•y t·ªïng ti·ªÅn hi·ªán t·∫°i (lo·∫°i b·ªè d·∫•u ch·∫•m ƒë·ªÉ parse s·ªë)
        const totalStr = document
          .getElementById("totalValue")
          .innerText.replace(/\./g, "")
          .replace(/,/g, "");
        const total = parseInt(totalStr);

        const guestInput = document.getElementById("inputGuestMoney").value;
        const guest = guestInput ? parseInt(guestInput) : 0;
        const output = document.getElementById("changeOutput");

        if (!guest) {
          output.innerText = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ti·ªÅn kh√°ch ƒë∆∞a";
          output.style.color = "#ff7675";
          return;
        }

        if (guest < total) {
          const missing = total - guest;
          output.innerText = "Kh√°ch thi·∫øu: " + formatMoney(missing) + " ‚Ç´";
          output.style.color = "#d63031";
        } else {
          const change = guest - total;
          output.innerHTML =
            "Tr·∫£ l·∫°i kh√°ch: <span style='font-size:1.4rem; color:#00b894'>" +
            formatMoney(change) +
            " ‚Ç´</span>";
          output.style.color = "#2d3436";
        }
      }
    </script>
  </body>
</html>
